import{u as C}from"./Bpf85daN.js";import{P as W,b4 as X,aU as Y,r as v,U as M,ad as Z,a as q,b as ee,o as U,w as o,g as u,e as a,h as B,k as y,F as te,j as ae,t as P}from"./CKxg9VfS.js";import{a as re}from"./Bjtksisr.js";import{B as ne}from"./CkclNe_0.js";import{_ as le}from"./B6-CO9cE.js";import{_ as ie}from"./BjVYSpcv.js";import{_ as se}from"./BHMcXTSu.js";import{_ as oe}from"./C12eGbIP.js";import{_ as ue}from"./DpFlcqSt.js";import{_ as pe}from"./BpvOLQCW.js";import{_ as ce}from"./Bt2YpT3E.js";const de={class:"col-span-2"},me={class:"flex justify-between items-center mb-4"},_e={class:"grid grid-cols-3 gap-4"},ve={class:"flex justify-end mt-2"},be={class:"col-span-2"},ye={class:"flex justify-end"},ge={class:"grid grid-cols-2 gap-4 min-w-[300px]"},he={class:"font-medium"},fe={class:"font-medium"},xe={class:"font-bold text-primary"},we={class:"col-span-2 flex justify-end gap-4 mt-4"},qe={__name:"AddEdit",setup(Ue){const b=X(),E=Y(),S=v(null),i=v({supplier:null,date:Date.now(),invoice_no:null,payment_type:null,items:[{medicine:null,batch_id:null,expiry_date:null,box_pattern:null,box_quantity:0,unit_quantity:0,supplier_price:0,mrp:0,vat:0}]}),g=v([]),h=v([]),R=[{label:"Cash",value:"cash"},{label:"Bank Transfer",value:"bank"},{label:"Credit",value:"credit"}],D=v(new Map),{data:A,loading:Pe,fetchData:$}=C(async({page:t,limit:e})=>(await(await fetch("/api/medicine?"+new URLSearchParams({page:t.toString(),limit:e.toString()}))).json()).data),{data:O,loading:Se,fetchData:F}=C(async({page:t,limit:e})=>(await re.get("/api/suppliers",{params:{page:t,limit:100}})).data);M(A,t=>{t&&(h.value=t.map(e=>({label:e.name,value:e._id})),D.value=new Map(t.map(e=>[e._id,e])))},{immediate:!0}),M(O,t=>{t&&(g.value=t.map(e=>({label:e.name,value:e._id})))},{immediate:!0});const f=async()=>{try{const e=await(await fetch("/api/purchase?"+new URLSearchParams({page:"1",limit:"1",sort:"-invoice_no"}))).json();let n=1;if(e.data&&e.data.length>0){const c=e.data[0].invoice_no.match(/INV-(\d+)/);c&&(n=parseInt(c[1])+1)}i.value.invoice_no=`INV-${String(n).padStart(3,"0")}`}catch(t){console.error("Error generating invoice number:",t);const e=Date.now().toString().slice(-6);i.value.invoice_no=`INV-${e}`}};Z(async()=>{try{await Promise.all([$({page:1,limit:100}),F({page:1,limit:100}),f()]),await G()}catch(t){console.error("Error fetching initial data:",t),g.value=[],h.value=[]}});const x=t=>{if(!t.box_pattern||!t.box_quantity)return 0;const[e,n]=t.box_pattern.split("x").map(Number);return e*n*t.box_quantity},N=q(()=>i.value.items.reduce((t,e)=>t+e.supplier_price*x(e),0)),T=q(()=>i.value.items.reduce((t,e)=>{const n=e.supplier_price*x(e);return t+n*e.vat/100},0)),k=q(()=>N.value+T.value),L=()=>{i.value.items.push({medicine:null,batch_id:null,expiry_date:null,box_pattern:null,box_quantity:0,unit_quantity:0,supplier_price:0,mrp:0,vat:0})},Q=t=>{i.value.items.splice(t,1)},j=t=>t<Date.now(),J={supplier:{required:!0,message:"Please select supplier",trigger:"blur"},date:{required:!0,message:"Please select date",trigger:["blur","change"],type:"number",validator:(t,e)=>e!=null&&!isNaN(e)},invoice_no:{required:!0,message:"Please enter invoice number",trigger:"blur"},payment_type:{required:!0,message:"Please select payment type",trigger:"change"},items:{type:"array",required:!0,message:"At least one item is required",trigger:"change",validator:(t,e)=>e&&e.length>0},"items[].medicine":{required:!0,message:"Please select medicine",trigger:"change"},"items[].batch_id":{required:!0,message:"Batch ID is required",trigger:"blur"},"items[].expiry_date":{required:!0,message:"Please select expiry date",trigger:"change"},"items[].box_pattern":{required:!0,message:"Please enter box pattern",trigger:"blur",validator:(t,e)=>e?/^\d+x\d+$/.test(e):!1},"items[].box_quantity":{required:!0,type:"number",min:1,message:"Quantity must be greater than 0",trigger:"change"},"items[].supplier_price":{required:!0,type:"number",min:0,message:"Price must be 0 or greater",trigger:"change"},"items[].mrp":{required:!0,type:"number",min:0,message:"MRP must be 0 or greater",trigger:"change"},"items[].vat":{required:!0,type:"number",min:0,max:100,message:"VAT must be between 0 and 100",trigger:"change"}},I=async()=>{i.value={supplier:null,date:Date.now(),invoice_no:null,payment_type:null,items:[{medicine:null,batch_id:null,expiry_date:null,box_pattern:null,box_quantity:0,unit_quantity:0,supplier_price:0,mrp:0,vat:0}]},await f()},z=()=>{var t;(t=S.value)==null||t.validate(async e=>{if(!e)try{const n=k.value,r={supplier:i.value.supplier,date:i.value.date,invoice_no:i.value.invoice_no,payment_type:i.value.payment_type,total:n,items:i.value.items.map(p=>{const m=x(p);return{medicine:p.medicine,batch_id:p.batch_id,expiry_date:p.expiry_date,box_pattern:p.box_pattern,box_quantity:p.box_quantity,unit_quantity:m,supplier_price:p.supplier_price,mrp:p.mrp,vat:p.vat,total_price:p.supplier_price*m}})};let c;if(b.params.id?c=await(await fetch(`/api/purchase/${b.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json():(await f(),c=await(await fetch("/api/purchase",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json()),c.status)console.log("Purchase created successfully"),I(),E.push("/purchase");else throw console.error("Purchase creation failed:",c.error||c.message),new Error(c.error||c.message||"Transaction failed")}catch(n){console.error("Error submitting form:",n),alert(`Error: ${n.message}`)}})},G=async()=>{if(b.params.id)try{const t=await fetch(`/api/purchase/${b.params.id}`);if(!t.ok)throw new Error(`Error: ${t.status}`);const n=(await t.json()).data;Object.assign(i.value,{supplier:n.supplier._id,date:n.date,invoice_no:n.invoice_no,payment_type:n.payment_type,items:n.items.map(r=>({medicine:r.medicine._id,batch_id:r.batch_id,expiry_date:r.expiry_date,box_pattern:r.box_pattern,box_quantity:r.box_quantity,supplier_price:r.supplier_price,mrp:r.mrp,vat:r.vat}))})}catch(t){console.error("❌ Lỗi khi fetch purchase:",t.message)}},H=(t,e)=>{if(!t){i.value.items[e].batch_id=null;return}const n=D.value.get(t);n&&(i.value.items[e].batch_id=n.bar_code||"")},w=t=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0}).format(t);return(t,e)=>{const n=se,r=ie,c=oe,p=ue,m=ne,_=pe,V=ce,K=le;return U(),ee(V,{class:"bg-gray-50 border-l-4 border-primary shadow-md"},{default:o(()=>[e[12]||(e[12]=u("div",{class:"flex justify-between items-center mb-4"},[u("h2",{class:"text-xl font-bold text-primary"},"Create New Purchase")],-1)),a(K,{ref_key:"formRef",ref:S,model:i.value,rules:J,"label-placement":"top",class:"grid grid-cols-2 gap-4"},{default:o(()=>[a(r,{label:"Supplier",path:"supplier"},{default:o(()=>[a(n,{value:i.value.supplier,"onUpdate:value":e[0]||(e[0]=l=>i.value.supplier=l),options:g.value,placeholder:"Select supplier",filterable:""},null,8,["value","options"])]),_:1}),a(r,{label:"Date",path:"date"},{default:o(()=>[a(c,{value:i.value.date,"onUpdate:value":e[1]||(e[1]=l=>i.value.date=l),type:"date",clearable:"","is-date-disabled":j,"value-format":"timestamp"},null,8,["value"])]),_:1}),a(r,{label:"Invoice No",path:"invoice_no"},{default:o(()=>[a(p,{value:i.value.invoice_no,"onUpdate:value":e[2]||(e[2]=l=>i.value.invoice_no=l),placeholder:"Auto generated",disabled:""},null,8,["value"])]),_:1}),a(r,{label:"Payment Type",path:"payment_type"},{default:o(()=>[a(n,{value:i.value.payment_type,"onUpdate:value":e[3]||(e[3]=l=>i.value.payment_type=l),options:R,placeholder:"Select payment type"},null,8,["value"])]),_:1}),u("div",de,[u("div",me,[e[5]||(e[5]=u("h3",{class:"text-lg font-medium text-primary"},"Medicine List",-1)),a(m,{type:"primary",onClick:L,class:"bg-primary"},{default:o(()=>e[4]||(e[4]=[y(" Add Medicine ")])),_:1,__:[4]})]),(U(!0),B(te,null,ae(i.value.items,(l,d)=>(U(),B("div",{key:d,class:"mb-4 p-4 border rounded-lg border-gray-200 hover:border-primary transition-colors"},[u("div",_e,[a(r,{label:"Medicine "+(d+1),path:"items["+d+"].medicine"},{default:o(()=>[a(n,{value:l.medicine,"onUpdate:value":[s=>l.medicine=s,s=>H(s,d)],options:h.value,placeholder:"Select medicine",filterable:""},null,8,["value","onUpdate:value","options"])]),_:2},1032,["label","path"]),a(r,{label:"Batch ID",path:"items["+d+"].batch_id"},{default:o(()=>[a(p,{value:l.batch_id,"onUpdate:value":s=>l.batch_id=s,placeholder:"Enter batch ID",disabled:""},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"Expiry Date",path:"items["+d+"].expiry_date"},{default:o(()=>[a(c,{value:l.expiry_date,"onUpdate:value":s=>l.expiry_date=s,type:"date",clearable:"","is-date-disabled":j},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"Box Pattern",path:"items["+d+"].box_pattern"},{default:o(()=>[a(p,{value:l.box_pattern,"onUpdate:value":s=>l.box_pattern=s,placeholder:"e.g. 10x10"},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"Box Quantity",path:"items["+d+"].box_quantity"},{default:o(()=>[a(_,{value:l.box_quantity,"onUpdate:value":s=>l.box_quantity=s,min:0},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"Unit Quantity",path:"items["+d+"].unit_quantity"},{default:o(()=>[a(_,{value:l.unit_quantity,"onUpdate:value":s=>l.unit_quantity=s,min:0,disabled:""},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"Supplier Price",path:"items["+d+"].supplier_price"},{default:o(()=>[a(_,{value:l.supplier_price,"onUpdate:value":s=>l.supplier_price=s,min:0},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"MRP",path:"items["+d+"].mrp"},{default:o(()=>[a(_,{value:l.mrp,"onUpdate:value":s=>l.mrp=s,min:0},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),a(r,{label:"VAT (%)",path:"items["+d+"].vat"},{default:o(()=>[a(_,{value:l.vat,"onUpdate:value":s=>l.vat=s,min:0,max:100},null,8,["value","onUpdate:value"])]),_:2},1032,["path"])]),u("div",ve,[a(m,{type:"error",class:"bg-red-500 hover:bg-red-600 text-white",onClick:s=>Q(d)},{default:o(()=>e[6]||(e[6]=[y(" Remove ")])),_:2,__:[6]},1032,["onClick"])])]))),128))]),u("div",be,[a(V,{title:"Summary",class:"mt-4 border-t-4 border-primary"},{default:o(()=>[u("div",ye,[u("div",ge,[e[7]||(e[7]=u("div",{class:"text-right text-gray-600"},"Subtotal:",-1)),u("div",he,P(w(N.value)),1),e[8]||(e[8]=u("div",{class:"text-right text-gray-600"},"Total VAT:",-1)),u("div",fe,P(w(T.value)),1),e[9]||(e[9]=u("div",{class:"text-right font-bold text-primary"},"Total:",-1)),u("div",xe,P(w(k.value)),1)])])]),_:1})]),u("div",we,[a(m,{onClick:I,class:"bg-gray-100 hover:bg-gray-200 text-gray-700"},{default:o(()=>e[10]||(e[10]=[y("Reset")])),_:1,__:[10]}),a(m,{type:"primary",onClick:z,class:"bg-primary hover:bg-primary-dark"},{default:o(()=>e[11]||(e[11]=[y("Save")])),_:1,__:[11]})])]),_:1},8,["model"])]),_:1,__:[12]})}}},Re=W(qe,[["__scopeId","data-v-ea20b22a"]]);export{Re as _};
