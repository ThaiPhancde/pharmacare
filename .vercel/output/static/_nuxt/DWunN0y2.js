import{a as w}from"./Bjtksisr.js";import{d as H,aT as X,r as f,a as Y,ad as G,b5 as J,h as K,g as l,e as o,w as u,u as r,o as Z,k as v,X as ee,t as te,a0 as N}from"./CKxg9VfS.js";import{B as I}from"./CkclNe_0.js";import{_ as ne}from"./gx_7XIuc.js";import{u as ae}from"./B9Nuy0Yo.js";import{_ as re,a as oe}from"./D9m8h4ON.js";import{_ as ie}from"./Bt2YpT3E.js";import{_ as le}from"./BjVYSpcv.js";import{_ as se}from"./DpFlcqSt.js";import{_ as ue}from"./C12eGbIP.js";import{_ as de}from"./BHMcXTSu.js";import{_ as me}from"./CEFh3Vxc.js";import{_ as ce}from"./BpvOLQCW.js";import"./mUUuLyVv.js";import"./CbhVS3Xc.js";import"./Be7d-GBD.js";import"./HiGXOwLp.js";import"./ChAwXecA.js";import"./gy6MXjwN.js";import"./DDBjNozI.js";import"./CfojvlWq.js";import"./BH030lJW.js";import"./Be3VPoHw.js";import"./BH33Gl0k.js";import"./DboHdRIr.js";import"./CMIqKt_m.js";import"./fmyKo3Du.js";import"./CeAEZXwI.js";import"./BloDjXvy.js";import"./DlZP_T-Q.js";import"./BUV3okvS.js";const pe={class:"mb-4"},ve={class:"flex justify-between items-center mb-4"},_e={class:"flex gap-2"},fe={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},be={class:"mb-4"},ge={class:"mb-4"},ye={class:"flex justify-between"},Ie={class:"text-right text-xl"},Ze=H({__name:"add",setup(ke){const x=X(),c=ae(),m=f(!1),k=f([]),b=f([]),s=f(null),g=f(""),n=f({returnNumber:E(),invoiceId:"",customerId:"",returnDate:Date.now(),totalAmount:0,reason:"",status:"Pending",items:[]}),$=Y(()=>k.value.map(e=>{var t;return{label:`${e.invoice_number||"No ID"} - ${new Date(e.date).toLocaleDateString()} - ${((t=e.customer)==null?void 0:t.full_name)||"Unknown"}`,value:e._id}})),P=[{label:"Pending",value:"Pending"},{label:"Completed",value:"Completed"},{label:"Cancelled",value:"Cancelled"}],U=[{label:"Wrong Item",value:"Wrong Item"},{label:"Expired",value:"Expired"},{label:"Damaged",value:"Damaged"},{label:"Customer Changed Mind",value:"Customer Changed Mind"},{label:"Product Recall",value:"Product Recall"},{label:"Other",value:"Other"}],y=e=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0}).format(e||0),q=[{title:"Medicine",key:"medicineName",render:e=>{var t;return((t=e.medicine)==null?void 0:t.name)||"Unknown"}},{title:"Batch ID",key:"batch_id"},{title:"Expiry Date",key:"expiry_date",render:e=>e.expiry_date?new Date(e.expiry_date).toLocaleDateString():"N/A"},{title:"Quantity",key:"quantity"},{title:"Unit Price",key:"price",render:e=>y(e.price||0)},{title:"Amount",key:"subtotal",render:e=>y(e.subtotal||0)},{title:"Action",key:"actions",render:e=>N(I,{size:"small",onClick:()=>{B(e)}},{default:()=>"Select"})}],M=[{title:"Medicine",key:"medicineName"},{title:"Batch ID",key:"batchId"},{title:"Expiry Date",key:"expiryDate",render:e=>e.expiryDate?new Date(e.expiryDate).toLocaleDateString():"N/A"},{title:"Quantity",key:"quantity",render:e=>N(ce,{value:e.quantity,min:1,max:L(e),onUpdateValue:t=>{t!==null&&Q(e,t)}})},{title:"Unit Price",key:"unitPrice",render:e=>y(e.unitPrice||0)},{title:"Amount",key:"amount",render:e=>y(e.amount||0)},{title:"Action",key:"actions",render:e=>N(I,{size:"small",type:"error",onClick:()=>{O(e)}},{default:()=>"Remove"})}];function E(){const e=new Date,t=e.getFullYear().toString().slice(-2),a=(e.getMonth()+1).toString().padStart(2,"0"),d=e.getDate().toString().padStart(2,"0"),p=Math.floor(Math.random()*1e4).toString().padStart(4,"0");return`RET-${t}${a}${d}-${p}`}const F=async()=>{try{m.value=!0;const e=await w.get("/api/invoice",{params:{limit:100}});e.status&&e.data?k.value=Array.isArray(e.data)?e.data:[]:k.value=[]}catch(e){console.error("Error fetching invoices:",e),k.value=[],c.error("Failed to fetch invoices")}finally{m.value=!1}},T=async e=>{if(e)try{m.value=!0;const t=await w.get(`/api/invoice/${e}`);if(t.status&&t.data){const a=t.data;console.log("Invoice data:",a),a.customer?(n.value.customerId=a.customer._id||"",g.value=a.customer.full_name||"Unknown"):(n.value.customerId="",g.value="Walk-in Customer"),Array.isArray(a.items)?(b.value=a.items||[],console.log("Invoice items:",b.value)):b.value=[],n.value.items=[],s.value=null}}catch(t){console.error("Error fetching invoice details:",t),c.error("Failed to fetch invoice details")}finally{m.value=!1}},B=e=>{s.value=e},V=()=>{var t,a;if(!s.value)return;if(n.value.items.find(d=>{var p;return d.medicineId===(((p=s.value.medicine)==null?void 0:p._id)||s.value.medicine)&&d.batchId===s.value.batch_id})){c.warning("This item is already added to the return");return}console.log("Selected item:",s.value),n.value.items.push({medicineId:((t=s.value.medicine)==null?void 0:t._id)||s.value.medicine,medicineName:((a=s.value.medicine)==null?void 0:a.name)||"Unknown",batchId:s.value.batch_id,expiryDate:s.value.expiry_date,quantity:1,unitPrice:s.value.price||0,amount:s.value.price||0}),D(),s.value=null},O=e=>{const t=n.value.items.findIndex(a=>a.medicineId===e.medicineId&&a.batchId===e.batchId);t!==-1&&(n.value.items.splice(t,1),D())},Q=(e,t)=>{const a=n.value.items.findIndex(d=>d.medicineId===e.medicineId&&d.batchId===e.batchId);a!==-1&&(n.value.items[a].quantity=t,n.value.items[a].amount=t*n.value.items[a].unitPrice,D())},L=e=>{const t=b.value.find(a=>{var d;return(((d=a.medicine)==null?void 0:d._id)||a.medicine)===e.medicineId&&a.batch_id===e.batchId});return t?t.quantity:0},S=()=>n.value.items.reduce((e,t)=>e+(t.amount||0),0),D=()=>{n.value.totalAmount=S()},W=async()=>{if(!n.value.invoiceId){c.error("Please select an invoice");return}if(!n.value.items.length){c.error("Please add at least one item to return");return}if(!n.value.reason){c.error("Please select a reason for the return");return}m.value=!0,console.log("Saving return with data:",n.value);try{const e=await w.post("/api/returns/customer",n.value);if(console.log("Save response:",e),e.status){c.success("Return created successfully");const t=e.data;t&&t.returnNumber&&c.info(`Return number: ${t.returnNumber}`),setTimeout(()=>{x.push("/returns")},1500)}else c.error(e.error||"Failed to create return")}catch(e){console.error("Error creating return:",e),c.error("Failed to create return: "+(e.message||"Unknown error"))}finally{m.value=!1}};return G(()=>{F()}),J({title:"New Customer Return"}),(e,t)=>{const a=oe,d=re,p=se,_=le,j=ue,h=de,C=ie,R=me,z=ne;return Z(),K("div",null,[l("div",pe,[o(d,null,{default:u(()=>[o(a,{onClick:t[0]||(t[0]=i=>r(x).push("/returns"))},{default:u(()=>t[8]||(t[8]=[v(" Returns ")])),_:1,__:[8]}),o(a,null,{default:u(()=>t[9]||(t[9]=[v(" New Customer Return ")])),_:1,__:[9]})]),_:1})]),l("div",ve,[t[12]||(t[12]=l("div",null,[l("h1",{class:"text-2xl font-bold"},"New Customer Return"),l("p",{class:"text-gray-500 dark:text-gray-400"}," Create a new return from customer ")],-1)),l("div",_e,[o(r(I),{onClick:t[1]||(t[1]=i=>r(x).back())},{default:u(()=>t[10]||(t[10]=[v("Cancel")])),_:1,__:[10]}),o(r(I),{loading:r(m),onClick:W},{default:u(()=>t[11]||(t[11]=[v("Save Return")])),_:1,__:[11]},8,["loading"])])]),o(C,{class:"mb-4"},{default:u(()=>[l("div",fe,[l("div",null,[o(_,{label:"Return Number",required:""},{default:u(()=>[o(p,{value:r(n).returnNumber,"onUpdate:value":t[2]||(t[2]=i=>r(n).returnNumber=i),placeholder:"Auto-generated",disabled:""},null,8,["value"])]),_:1})]),l("div",null,[o(_,{label:"Return Date",required:""},{default:u(()=>[o(j,{value:r(n).returnDate,"onUpdate:value":t[3]||(t[3]=i=>r(n).returnDate=i),type:"date",class:"w-full",disabled:r(m)},null,8,["value","disabled"])]),_:1})]),l("div",null,[o(_,{label:"Invoice",required:""},{default:u(()=>[o(h,{value:r(n).invoiceId,"onUpdate:value":[t[4]||(t[4]=i=>r(n).invoiceId=i),T],filterable:"",options:r($),placeholder:"Select invoice",disabled:r(m)},null,8,["value","options","disabled"])]),_:1})]),l("div",null,[o(_,{label:"Customer",required:""},{default:u(()=>[o(p,{value:r(g),"onUpdate:value":t[5]||(t[5]=i=>ee(g)?g.value=i:null),disabled:""},null,8,["value"])]),_:1})]),l("div",null,[o(_,{label:"Status",required:""},{default:u(()=>[o(h,{value:r(n).status,"onUpdate:value":t[6]||(t[6]=i=>r(n).status=i),options:P,disabled:r(m)},null,8,["value","disabled"])]),_:1})]),l("div",null,[o(_,{label:"Reason",required:""},{default:u(()=>[o(h,{value:r(n).reason,"onUpdate:value":t[7]||(t[7]=i=>r(n).reason=i),options:U,placeholder:"Select reason",disabled:r(m)},null,8,["value","disabled"])]),_:1})])])]),_:1}),o(C,{class:"mb-4",title:"Invoice Items"},{default:u(()=>[o(R,{columns:q,data:r(b),pagination:!1,"row-key":i=>{var A;return i._id||((A=i.medicine)==null?void 0:A._id)}},null,8,["data","row-key"])]),_:1}),o(C,{title:"Return Items"},{default:u(()=>[l("div",be,[o(z,{type:"warning"},{default:u(()=>t[13]||(t[13]=[v(" Select items from the invoice to return. Validate the quantity to be returned. ")])),_:1,__:[13]})]),l("div",ge,[o(R,{columns:M,data:r(n).items,pagination:!1,"row-key":i=>i._id||`${i.medicineId}-${i.batchId}`},null,8,["data","row-key"])]),l("div",ye,[l("div",null,[o(r(I),{onClick:V,disabled:!r(s)},{default:u(()=>t[14]||(t[14]=[v(" Add Selected Item ")])),_:1,__:[14]},8,["disabled"])]),l("div",null,[l("div",Ie,[t[15]||(t[15]=v(" Total Amount: ")),l("strong",null,te(y(S())),1)])])])]),_:1})])}}});export{Ze as default};
