import{a as N}from"./Bjtksisr.js";import{d as W,aT as H,r as f,a as X,ad as Y,b5 as G,h as J,g as u,e as r,w as o,u as a,o as K,k as _,X as Z,t as ee,a0 as w}from"./CKxg9VfS.js";import{B as b}from"./CkclNe_0.js";import{u as te}from"./B9Nuy0Yo.js";import{_ as ne,a as ae}from"./D9m8h4ON.js";import{_ as re}from"./Bt2YpT3E.js";import{_ as le}from"./BjVYSpcv.js";import{_ as ie}from"./DpFlcqSt.js";import{_ as ue}from"./C12eGbIP.js";import{_ as se}from"./BHMcXTSu.js";import{_ as oe}from"./CEFh3Vxc.js";import{_ as de}from"./gx_7XIuc.js";import{_ as ce}from"./BpvOLQCW.js";import"./mUUuLyVv.js";import"./CbhVS3Xc.js";import"./Be7d-GBD.js";import"./HiGXOwLp.js";import"./ChAwXecA.js";import"./gy6MXjwN.js";import"./DDBjNozI.js";import"./CfojvlWq.js";import"./BH030lJW.js";import"./Be3VPoHw.js";import"./BH33Gl0k.js";import"./DboHdRIr.js";import"./CMIqKt_m.js";import"./fmyKo3Du.js";import"./CeAEZXwI.js";import"./BloDjXvy.js";import"./DlZP_T-Q.js";import"./BUV3okvS.js";const me={class:"mb-4"},pe={class:"flex justify-between items-center mb-4"},_e={class:"flex gap-2"},ve={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},fe={class:"mb-4"},ye={class:"mb-4"},be={class:"flex justify-between"},ge={class:"text-right text-xl"},Ke=W({__name:"add",setup(he){const I=H(),p=te(),c=f(!1),g=f([]),k=f([]),d=f(null),h=f(""),n=f({returnNumber:E(),purchaseId:"",supplierId:"",returnDate:Date.now(),totalAmount:0,reason:"",status:"Pending",items:[]}),$=X(()=>g.value.map(e=>{var t;return{label:`${e.invoice_no} - ${new Date(e.date).toLocaleDateString()} - ${((t=e.supplier)==null?void 0:t.name)||"Unknown"}`,value:e._id}})),C=[{label:"Pending",value:"Pending"},{label:"Completed",value:"Completed"},{label:"Cancelled",value:"Cancelled"}],q=[{label:"Damaged",value:"Damaged"},{label:"Expired",value:"Expired"},{label:"Wrong Item",value:"Wrong Item"},{label:"Quality Issue",value:"Quality Issue"},{label:"Product Recall",value:"Product Recall"},{label:"Other",value:"Other"}],A=[{title:"Medicine",key:"medicineName",render:e=>{var t;return((t=e.medicine)==null?void 0:t.name)||"Unknown"}},{title:"Batch ID",key:"batch_id"},{title:"Expiry Date",key:"expiry_date",render:e=>e.expiry_date?new Date(e.expiry_date).toLocaleDateString():"N/A"},{title:"Quantity",key:"unit_quantity",render:e=>`${e.unit_quantity} units`},{title:"Unit Price",key:"supplier_price",render:e=>y(e.supplier_price||0)},{title:"Amount",key:"amount",render:e=>y((e.supplier_price||0)*(e.unit_quantity||0))},{title:"Action",key:"actions",render:e=>w(b,{size:"small",onClick:()=>{M(e)}},{default:()=>"Select"})}],U=[{title:"Medicine",key:"medicineName"},{title:"Batch ID",key:"batchId"},{title:"Expiry Date",key:"expiryDate",render:e=>e.expiryDate?new Date(e.expiryDate).toLocaleDateString():"N/A"},{title:"Quantity",key:"quantity",render:e=>w(ce,{value:e.quantity,min:1,max:O(e),onUpdateValue:t=>{t!==null&&V(e,t)}})},{title:"Unit Price",key:"unitPrice",render:e=>y(e.unitPrice||0)},{title:"Amount",key:"amount",render:e=>y(e.amount||0)},{title:"Action",key:"actions",render:e=>w(b,{size:"small",type:"error",onClick:()=>{Q(e)}},{default:()=>"Remove"})}],y=e=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0}).format(e||0);function E(){const e=new Date,t=e.getFullYear().toString().slice(-2),l=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0"),m=Math.floor(Math.random()*1e4).toString().padStart(4,"0");return`SRET-${t}${l}${s}-${m}`}const F=async()=>{try{c.value=!0;const e=await N.get("/api/purchase",{params:{limit:100}});e.status&&e.data?g.value=Array.isArray(e.data)?e.data:[]:g.value=[]}catch(e){console.error("Error fetching purchases:",e),g.value=[],p.error("Failed to fetch purchases")}finally{c.value=!1}},T=async e=>{var t,l;if(e)try{c.value=!0;const s=await N.get(`/api/purchase/${e}`);if(s.status&&s.data){const m=s.data;n.value.supplierId=((t=m.supplier)==null?void 0:t._id)||"",h.value=((l=m.supplier)==null?void 0:l.name)||"Unknown",k.value=m.items||[],n.value.items=[],d.value=null}}catch(s){console.error("Error fetching purchase details:",s),p.error("Failed to fetch purchase details")}finally{c.value=!1}},M=e=>{d.value=e},B=()=>{var t,l;if(!d.value)return;if(n.value.items.find(s=>{var m;return s.medicineId===(((m=d.value.medicine)==null?void 0:m._id)||d.value.medicine)&&s.batchId===d.value.batch_id})){p.warning("This item is already added to the return");return}n.value.items.push({medicineId:((t=d.value.medicine)==null?void 0:t._id)||d.value.medicine,medicineName:((l=d.value.medicine)==null?void 0:l.name)||"Unknown",batchId:d.value.batch_id,expiryDate:d.value.expiry_date,quantity:1,unitPrice:d.value.supplier_price||0,amount:d.value.supplier_price||0}),x(),d.value=null},Q=e=>{const t=n.value.items.findIndex(l=>l.medicineId===e.medicineId&&l.batchId===e.batchId);t!==-1&&(n.value.items.splice(t,1),x())},V=(e,t)=>{const l=n.value.items.findIndex(s=>s.medicineId===e.medicineId&&s.batchId===e.batchId);l!==-1&&(n.value.items[l].quantity=t,n.value.items[l].amount=t*n.value.items[l].unitPrice,x())},O=e=>{const t=k.value.find(l=>{var s;return(((s=l.medicine)==null?void 0:s._id)||l.medicine)===e.medicineId&&l.batch_id===e.batchId});return t?t.unit_quantity:0},R=()=>n.value.items.reduce((e,t)=>e+(t.amount||0),0),x=()=>{n.value.totalAmount=R()},L=async()=>{if(!n.value.purchaseId){p.error("Please select a purchase");return}if(!n.value.items.length){p.error("Please add at least one item to return");return}if(!n.value.reason){p.error("Please select a reason for the return");return}c.value=!0,console.log("Saving supplier return with data:",n.value);try{const e=await N.post("/api/returns/supplier",n.value);if(console.log("Save response:",e),e.status){p.success("Return created successfully");const t=e.data;t&&t.returnNumber&&p.info(`Return number: ${t.returnNumber}`),setTimeout(()=>{I.push("/returns")},1500)}else p.error(e.error||"Failed to create return")}catch(e){console.error("Error creating return:",e),p.error("Failed to create return: "+(e.message||"Unknown error"))}finally{c.value=!1}};return Y(()=>{F()}),G({title:"New Supplier Return"}),(e,t)=>{const l=ae,s=ne,m=ie,v=le,j=ue,S=se,D=re,P=oe,z=de;return K(),J("div",null,[u("div",me,[r(s,null,{default:o(()=>[r(l,{onClick:t[0]||(t[0]=i=>a(I).push("/returns"))},{default:o(()=>t[8]||(t[8]=[_(" Returns ")])),_:1,__:[8]}),r(l,null,{default:o(()=>t[9]||(t[9]=[_(" New Supplier Return ")])),_:1,__:[9]})]),_:1})]),u("div",pe,[t[12]||(t[12]=u("div",null,[u("h1",{class:"text-2xl font-bold"},"New Supplier Return"),u("p",{class:"text-gray-500 dark:text-gray-400"}," Create a new return to supplier ")],-1)),u("div",_e,[r(a(b),{onClick:t[1]||(t[1]=i=>a(I).back())},{default:o(()=>t[10]||(t[10]=[_("Cancel")])),_:1,__:[10]}),r(a(b),{loading:a(c),onClick:L},{default:o(()=>t[11]||(t[11]=[_("Save Return")])),_:1,__:[11]},8,["loading"])])]),r(D,{class:"mb-4"},{default:o(()=>[u("div",ve,[u("div",null,[r(v,{label:"Return Number",required:""},{default:o(()=>[r(m,{value:a(n).returnNumber,"onUpdate:value":t[2]||(t[2]=i=>a(n).returnNumber=i),placeholder:"Auto-generated",disabled:""},null,8,["value"])]),_:1})]),u("div",null,[r(v,{label:"Return Date",required:""},{default:o(()=>[r(j,{value:a(n).returnDate,"onUpdate:value":t[3]||(t[3]=i=>a(n).returnDate=i),type:"date",class:"w-full",disabled:a(c)},null,8,["value","disabled"])]),_:1})]),u("div",null,[r(v,{label:"Purchase",required:""},{default:o(()=>[r(S,{value:a(n).purchaseId,"onUpdate:value":[t[4]||(t[4]=i=>a(n).purchaseId=i),T],filterable:"",options:a($),placeholder:"Select purchase",disabled:a(c)},null,8,["value","options","disabled"])]),_:1})]),u("div",null,[r(v,{label:"Supplier",required:""},{default:o(()=>[r(m,{value:a(h),"onUpdate:value":t[5]||(t[5]=i=>Z(h)?h.value=i:null),disabled:""},null,8,["value"])]),_:1})]),u("div",null,[r(v,{label:"Status",required:""},{default:o(()=>[r(S,{value:a(n).status,"onUpdate:value":t[6]||(t[6]=i=>a(n).status=i),options:C,disabled:a(c)},null,8,["value","disabled"])]),_:1})]),u("div",null,[r(v,{label:"Reason",required:""},{default:o(()=>[r(S,{value:a(n).reason,"onUpdate:value":t[7]||(t[7]=i=>a(n).reason=i),options:q,placeholder:"Select reason",disabled:a(c)},null,8,["value","disabled"])]),_:1})])])]),_:1}),r(D,{class:"mb-4",title:"Purchase Items"},{default:o(()=>[r(P,{columns:A,data:a(k),pagination:!1,"row-key":i=>i._id||`${i.medicineId}-${i.batchId}`},null,8,["data","row-key"])]),_:1}),r(D,{title:"Return Items"},{default:o(()=>[u("div",fe,[r(z,{type:"warning"},{default:o(()=>t[13]||(t[13]=[_(" Select items from the purchase to return. Specify the reason and quantity to be returned. ")])),_:1,__:[13]})]),u("div",ye,[r(P,{columns:U,data:a(n).items,pagination:!1,"row-key":i=>i._id||`${i.medicineId}-${i.batchId}`},null,8,["data","row-key"])]),u("div",be,[u("div",null,[r(a(b),{onClick:B,disabled:!a(d)},{default:o(()=>t[14]||(t[14]=[_(" Add Selected Item ")])),_:1,__:[14]},8,["disabled"])]),u("div",null,[u("div",ge,[t[15]||(t[15]=_(" Total Amount: ")),u("strong",null,ee(y(R())),1)])])])]),_:1})])}}});export{Ke as default};
