import{a as b}from"./Bjtksisr.js";import{aI as K,r as y,a as A,ad as W,b as X,w as d,aU as Y,o as N,g as r,e as i,h as E,k as h,F as Z,j as ee,t as x}from"./CKxg9VfS.js";import{_ as te}from"./Bt2YpT3E.js";import{_ as ae}from"./C12eGbIP.js";import{B as le}from"./CkclNe_0.js";import{_ as oe}from"./BpvOLQCW.js";import{_ as ie}from"./B6-CO9cE.js";import{_ as re}from"./BjVYSpcv.js";import{_ as ne}from"./BHMcXTSu.js";import{_ as se}from"./DpFlcqSt.js";import"./CbhVS3Xc.js";import"./HiGXOwLp.js";import"./DDBjNozI.js";import"./CfojvlWq.js";import"./gy6MXjwN.js";import"./ChAwXecA.js";import"./Be7d-GBD.js";import"./BH030lJW.js";import"./Be3VPoHw.js";import"./BH33Gl0k.js";import"./mUUuLyVv.js";import"./BUV3okvS.js";import"./DboHdRIr.js";import"./CMIqKt_m.js";const ue={class:"col-span-2"},de={class:"flex justify-between items-center mb-4"},ce={class:"grid grid-cols-3 gap-4"},me={class:"flex justify-end mt-2"},pe={class:"col-span-2"},ve={class:"flex justify-end"},_e={class:"grid grid-cols-2 gap-4 min-w-[300px]"},be={class:"font-medium"},ye={class:"font-medium"},ge={class:"font-medium"},fe={class:"font-bold text-primary"},he={class:"font-medium"},xe={class:"font-bold text-primary"},qe={class:"col-span-2 flex justify-end gap-4 mt-4"},Je={__name:"add",setup(we){const O=Y(),p=K(),D=y(null),t=y({customer:null,date:Date.now(),invoice_no:null,payment_method:"cash",items:[],subtotal:0,vat_total:0,discount:0,grand_total:0,paid:0,due:0,is_pos:!1}),V=y([]),C=y([]),_=y({}),j=[{label:"Cash",value:"cash"},{label:"Credit Card",value:"card"},{label:"Bank Transfer",value:"bank"}],k=async()=>{try{const a=await b.get("/api/medicine",{params:{limit:100}});a.status&&a.data&&(C.value=a.data.map(l=>({label:l.name,value:l._id})));const e=await b.get("/api/stock",{params:{limit:999}});e.status&&e.data&&e.data.forEach(l=>{l.medicine&&(_.value[l.medicine._id]||(_.value[l.medicine._id]=[]),_.value[l.medicine._id].push({batch_id:l.batch_id,expiry_date:l.expiry_date,unit_quantity:l.unit_quantity,mrp:l.mrp,vat:l.vat}))})}catch(a){console.error("Failed to fetch medicines or stock:",a),p.error("Failed to load medicines or stock")}},L=async()=>{try{const a=await b.get("/api/customers",{params:{limit:100}});a.status&&a.data&&(V.value=a.data.map(e=>({label:e.full_name||e.customer_id,value:e._id})))}catch(a){console.error("Failed to fetch customers:",a),p.error("Failed to load customers")}},T=async()=>{try{const a=await b.get("/api/invoice",{params:{limit:1}});let e=1;if(a.status&&a.data&&a.data.length>0){const l=a.data[0].invoice_no,u=l==null?void 0:l.match(/INV-(\d+)/);u&&(e=parseInt(u[1])+1)}t.value.invoice_no=`INV-${String(e).padStart(3,"0")}`}catch(a){console.error("Error generating invoice number:",a);const e=Date.now().toString().slice(-6);t.value.invoice_no=`INV-${e}`}},B=a=>!a||!_.value[a]?[]:_.value[a].map(e=>({label:`${e.batch_id} (Exp: ${new Date(e.expiry_date).toLocaleDateString()}) - Qty: ${e.unit_quantity}`,value:e.batch_id,expiry_date:e.expiry_date,mrp:e.mrp,vat:e.vat,available_qty:e.unit_quantity})),R=(a,e)=>{if(!a){const l=t.value.items[e];l.batch_id=null,l.expiry_date=null,l.price=0,l.vat=0,l.quantity=1,l.max_quantity=1,l.subtotal=0,S()}},Q=(a,e,l)=>{if(!a||!e)return;const n=B(e).find(m=>m.value===a);if(n){const m=t.value.items[l];m.expiry_date=n.expiry_date,m.price=n.mrp,m.vat=n.vat,m.max_quantity=n.available_qty,m.quantity>n.available_qty&&(m.quantity=n.available_qty),F(m)}},F=a=>{a.subtotal=a.quantity*a.price,S()},q=A(()=>t.value.items.reduce((a,e)=>a+(e.subtotal||0),0)),w=A(()=>t.value.items.reduce((a,e)=>{const l=(e.subtotal||0)*(e.vat||0)/100;return a+l},0)),S=()=>{t.value.subtotal=q.value,t.value.vat_total=w.value,P()},P=()=>{t.value.grand_total=t.value.subtotal+t.value.vat_total-t.value.discount,$()},$=()=>{t.value.due=t.value.grand_total-t.value.paid},U=()=>{t.value.items.push({medicine:null,batch_id:null,expiry_date:null,quantity:1,price:0,vat:0,subtotal:0,max_quantity:1})},z=a=>{t.value.items.splice(a,1),S()},G={date:{required:!0,message:"Please select date",trigger:["blur","change"],type:"number",validator:(a,e)=>e!=null&&!isNaN(e)},invoice_no:{required:!0,message:"Invoice number is required",trigger:"blur"},payment_method:{required:!0,message:"Please select payment method",trigger:"change"},items:{type:"array",required:!0,message:"At least one item is required",trigger:"change",validator:(a,e)=>e&&e.length>0},"items[].medicine":{required:!0,message:"Please select medicine",trigger:"change"},"items[].batch_id":{required:!0,message:"Please select batch",trigger:"change"},"items[].quantity":{required:!0,type:"number",min:1,message:"Quantity must be at least 1",trigger:"change"},paid:{required:!0,type:"number",message:"Paid amount is required",trigger:"change"}},I=async()=>{t.value={customer:null,date:Date.now(),invoice_no:null,payment_method:"cash",items:[],subtotal:0,vat_total:0,discount:0,grand_total:0,paid:0,due:0,is_pos:!1},U(),await T()},H=()=>{var a;(a=D.value)==null||a.validate(async e=>{if(!e)try{if(t.value.items.some(n=>!n.medicine||!n.batch_id)){p.error("Please select medicine and batch for all items");return}if(t.value.paid<0){p.error("Paid amount cannot be negative");return}const l={date:t.value.date,customer:t.value.customer,invoice_no:t.value.invoice_no,payment_method:t.value.payment_method,items:t.value.items.map(n=>({medicine:n.medicine,batch_id:n.batch_id,expiry_date:n.expiry_date,quantity:n.quantity,price:n.price,vat:n.vat,subtotal:n.subtotal})),subtotal:t.value.subtotal,vat_total:t.value.vat_total,discount:t.value.discount,grand_total:t.value.grand_total,paid:t.value.paid,due:t.value.due,is_pos:!1},u=await b.post("/api/invoice",l);u.status?(p.success("Invoice created successfully"),I(),O.push("/invoice")):p.error(u.message||"Failed to create invoice")}catch(l){console.error("Error submitting form:",l),p.error(l.message||"An unexpected error occurred")}})},g=a=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND",minimumFractionDigits:0}).format(a);return W(async()=>{try{await Promise.all([k(),L(),T()]),U()}catch(a){console.error("Error initializing:",a),p.error("Failed to initialize data")}}),(a,e)=>{const l=ne,u=re,n=ae,m=se,f=le,v=oe,M=te,J=ie;return N(),X(M,{class:"bg-gray-50 border-l-4 border-primary shadow-md"},{default:d(()=>[e[17]||(e[17]=r("div",{class:"flex justify-between items-center mb-4"},[r("h2",{class:"text-xl font-bold text-primary"},"Create New Invoice")],-1)),i(J,{ref_key:"formRef",ref:D,model:t.value,rules:G,"label-placement":"top",class:"grid grid-cols-2 gap-4"},{default:d(()=>[i(u,{label:"Customer (Optional)",path:"customer"},{default:d(()=>[i(l,{value:t.value.customer,"onUpdate:value":e[0]||(e[0]=o=>t.value.customer=o),options:V.value,placeholder:"Select customer or leave empty for walk-in",filterable:"",clearable:""},null,8,["value","options"])]),_:1}),i(u,{label:"Date",path:"date"},{default:d(()=>[i(n,{value:t.value.date,"onUpdate:value":e[1]||(e[1]=o=>t.value.date=o),type:"date",clearable:"","value-format":"timestamp"},null,8,["value"])]),_:1}),i(u,{label:"Invoice No",path:"invoice_no"},{default:d(()=>[i(m,{value:t.value.invoice_no,"onUpdate:value":e[2]||(e[2]=o=>t.value.invoice_no=o),placeholder:"Auto generated",disabled:""},null,8,["value"])]),_:1}),i(u,{label:"Payment Method",path:"payment_method"},{default:d(()=>[i(l,{value:t.value.payment_method,"onUpdate:value":e[3]||(e[3]=o=>t.value.payment_method=o),options:j,placeholder:"Select payment method"},null,8,["value"])]),_:1}),r("div",ue,[r("div",de,[e[7]||(e[7]=r("h3",{class:"text-lg font-medium text-primary"},"Medicine List",-1)),i(f,{type:"primary",onClick:U,class:"bg-primary"},{default:d(()=>e[6]||(e[6]=[h(" Add Medicine ")])),_:1,__:[6]})]),(N(!0),E(Z,null,ee(t.value.items,(o,c)=>(N(),E("div",{key:c,class:"mb-4 p-4 border rounded-lg border-gray-200 hover:border-primary transition-colors"},[r("div",ce,[i(u,{label:"Medicine "+(c+1),path:"items["+c+"].medicine"},{default:d(()=>[i(l,{value:o.medicine,"onUpdate:value":[s=>o.medicine=s,s=>R(s,c)],options:C.value,placeholder:"Select medicine",filterable:""},null,8,["value","onUpdate:value","options"])]),_:2},1032,["label","path"]),i(u,{label:"Batch",path:"items["+c+"].batch_id"},{default:d(()=>[i(l,{value:o.batch_id,"onUpdate:value":[s=>o.batch_id=s,s=>Q(s,o.medicine,c)],options:B(o.medicine),placeholder:"Select batch",filterable:"",disabled:!o.medicine},null,8,["value","onUpdate:value","options","disabled"])]),_:2},1032,["path"]),i(u,{label:"Expiry Date",path:"items["+c+"].expiry_date"},{default:d(()=>[i(n,{value:o.expiry_date,"onUpdate:value":s=>o.expiry_date=s,type:"date",clearable:"",disabled:""},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),i(u,{label:"Quantity",path:"items["+c+"].quantity"},{default:d(()=>[i(v,{value:o.quantity,"onUpdate:value":[s=>o.quantity=s,s=>F(o)],min:1,max:o.max_quantity||1,disabled:!o.batch_id},null,8,["value","onUpdate:value","max","disabled"])]),_:2},1032,["path"]),i(u,{label:"Price",path:"items["+c+"].price"},{default:d(()=>[i(v,{value:o.price,"onUpdate:value":s=>o.price=s,min:0,disabled:""},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),i(u,{label:"VAT (%)",path:"items["+c+"].vat"},{default:d(()=>[i(v,{value:o.vat,"onUpdate:value":s=>o.vat=s,min:0,max:100,disabled:""},null,8,["value","onUpdate:value"])]),_:2},1032,["path"]),i(u,{label:"Subtotal",path:"items["+c+"].subtotal",class:"col-span-3"},{default:d(()=>[i(v,{value:o.subtotal,"onUpdate:value":s=>o.subtotal=s,min:0,disabled:"",formatter:s=>`${s.toLocaleString("vi-VN")} â‚«`},null,8,["value","onUpdate:value","formatter"])]),_:2},1032,["path"])]),r("div",me,[i(f,{type:"error",class:"bg-red-500 hover:bg-red-600 text-white",onClick:s=>z(c)},{default:d(()=>e[8]||(e[8]=[h(" Remove ")])),_:2,__:[8]},1032,["onClick"])])]))),128))]),r("div",pe,[i(M,{title:"Summary",class:"mt-4 border-t-4 border-primary"},{default:d(()=>[r("div",ve,[r("div",_e,[e[9]||(e[9]=r("div",{class:"text-right text-gray-600"},"Subtotal:",-1)),r("div",be,x(g(q.value)),1),e[10]||(e[10]=r("div",{class:"text-right text-gray-600"},"VAT Total:",-1)),r("div",ye,x(g(w.value)),1),e[11]||(e[11]=r("div",{class:"text-right text-gray-600"},"Discount:",-1)),r("div",ge,[i(v,{value:t.value.discount,"onUpdate:value":[e[4]||(e[4]=o=>t.value.discount=o),P],min:0,max:q.value+w.value,formatter:o=>`${o.toLocaleString("vi-VN")} â‚«`},null,8,["value","max","formatter"])]),e[12]||(e[12]=r("div",{class:"text-right font-bold text-primary"},"Grand Total:",-1)),r("div",fe,x(g(t.value.grand_total)),1),e[13]||(e[13]=r("div",{class:"text-right text-gray-600"},"Amount Paid:",-1)),r("div",he,[i(v,{value:t.value.paid,"onUpdate:value":[e[5]||(e[5]=o=>t.value.paid=o),$],min:0,formatter:o=>`${o.toLocaleString("vi-VN")} â‚«`},null,8,["value","formatter"])]),e[14]||(e[14]=r("div",{class:"text-right font-bold text-primary"},"Due Amount:",-1)),r("div",xe,x(g(t.value.due)),1)])])]),_:1})]),r("div",qe,[i(f,{onClick:I,class:"bg-gray-100 hover:bg-gray-200 text-gray-700"},{default:d(()=>e[15]||(e[15]=[h("Reset")])),_:1,__:[15]}),i(f,{type:"primary",onClick:H,class:"bg-primary hover:bg-primary-dark"},{default:d(()=>e[16]||(e[16]=[h("Save Invoice")])),_:1,__:[16]})])]),_:1},8,["model"])]),_:1,__:[17]})}}};export{Je as default};
