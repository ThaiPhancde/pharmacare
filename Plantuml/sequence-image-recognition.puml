@startuml
' Sequence diagrams: core flows (non-AI)

== Purchase & Stock Receiving ==
actor Staff
participant "UI Purchase" as PUI
participant "API /api/purchase" as PAPI
database "MongoDB\nMedicine/Stock/Purchase" as DB

Staff -> PUI : Create purchase order
PUI -> PAPI : POST purchase (supplier, items)
PAPI -> DB : validate supplier + medicine refs
DB --> PAPI : ok
PAPI -> DB : insert purchase + items
PAPI -> DB : upsert stock batches (expiry, pricing)
PAPI --> PUI : purchaseId, stock updates
PUI --> Staff : Show received batches

== POS Sale & Voucher ==
actor Cashier
participant "POS UI" as POS
participant "API /api/voucher/validate" as VAPI
participant "API /api/invoice/pos" as IAPI
database "MongoDB\nInvoice/Stock/Voucher" as DB2

Cashier -> POS : Scan items
POS -> DB2 : fetch stock batches (expiry, price)
DB2 --> POS : batch list
Cashier -> POS : Apply voucher code
POS -> VAPI : validate(code, total)
VAPI -> DB2 : check voucher rules/usage
DB2 --> VAPI : valid/invalid + discount
VAPI --> POS : discount result
Cashier -> POS : Confirm payment
POS -> IAPI : POST invoice (items, voucher, payment)
IAPI -> DB2 : lock/update stock quantities
IAPI -> DB2 : create invoice + items
IAPI --> POS : invoice number, totals
POS --> Cashier : Print receipt / success

== Shipping Order (GHN) ==
actor Cashier as ShipActor
participant "Shipping UI" as SUI
participant "API /api/shipping" as SAPI
participant "GHN Service" as GHN
database "MongoDB\nInvoice/Shipping" as DB3

ShipActor -> SUI : Request delivery
SUI -> SAPI : POST invoiceId, address, COD flag
SAPI -> DB3 : load invoice totals/weight
SAPI -> GHN : calculateFee + createOrder
GHN --> SAPI : fee, trackingCode
SAPI -> DB3 : save shipping (tracking, fee)
SAPI --> SUI : tracking, expected delivery
SUI --> ShipActor : Label + tracking shared

== Return (Customer) ==
actor Staff as RStaff
participant "Returns UI" as RUI
participant "API /api/returns/customer" as RAPI
database "MongoDB\nInvoice/Stock" as DB4

RStaff -> RUI : Enter invoice no., item
RUI -> RAPI : POST return request
RAPI -> DB4 : fetch invoice + item batch
DB4 --> RAPI : details
RAPI -> DB4 : adjust stock (restock or scrap)
RAPI -> DB4 : create refund/credit note
RAPI --> RUI : status, refund amount
RUI --> RStaff : Complete return

== Shift Closing ==
actor Cashier as CStaff
participant "Shift UI" as SHUI
participant "API /api/report/shift-closing" as SHAPI
database "MongoDB\nInvoice/Shift" as DB5

CStaff -> SHUI : Start closing
SHUI -> DB5 : load today invoices/payments
DB5 --> SHUI : totals
CStaff -> SHUI : Enter counted cash
SHUI -> SHAPI : POST closing (opening, sales, cash count)
SHAPI -> DB5 : persist closing report + status
SHAPI --> SHUI : confirmation, delta
SHUI --> CStaff : Closing summary
@enduml
